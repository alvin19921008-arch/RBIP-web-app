---
description: Essential architectural patterns and critical gotchas for RBIP duty list system
globs: ["**/*.ts", "**/*.tsx"]
alwaysApply: true
---

# Architecture Essentials

> **Purpose**: Critical architectural patterns and gotchas that new agents MUST know. For detailed changelog, see `CHANGELOG.md`.

## Critical Gotchas (Top 10)

1. **Database Type Safety (CRITICAL)**: Always use `lib/db/types.ts` utilities (`toDbLeaveType`, `programNamesToIds`, `normalizeFTE`) - TypeScript types are WIDER than database enums
2. **staffOverrides is Single Source of Truth**: All staff modifications must update `staffOverrides`; algorithms read from it
3. **Never Recalculate `average_pca_per_team` After Step 1**: It's a target value that persists through Steps 2-4
4. **Bed Relieving Calculations**: Use `totalBedsEffectiveAllTeams` (after SHS/students deductions) consistently - using raw `totalBedsAllTeams` creates impossible positive global sums
5. **Pending FTE Update Safety**: Always use `assignOneSlotAndUpdatePending()` for one-slot calls and `assignUpToPendingAndUpdatePending()` for global pending calls - never manually update `pendingFTE[team]` after calling wrappers
6. **TypeScript Strict Mode**: Use `createEmptyTeamRecord<T>()` for Record initialization, guard clauses instead of `!`, `PromiseLike<any>[]` for Supabase queries in `Promise.all()`
7. **Step 3 Wizard State**: Always clone state objects (`adjustedFTE`, `existingAllocations`) before modification; each mini-step progressively updates `currentPendingFTE` and `pcaAllocations`
8. **Adjacent Slot Logic (Step 3.3)**: Only considers slots actually assigned by special programs, NOT Step 3.2 assignments
9. **Bed Relieving Notes**: Stored in `staffOverrides.__bedRelieving` (within-day only, NOT copied across dates via copy schedule)
10. **Snapshot Envelope**: Always use `buildBaselineSnapshotEnvelope()` before saving; always validate with `validateAndRepairBaselineSnapshot()` on load

## State Management Architecture

### Three-Layer State Pattern
1. **Layer 1: Saved State** (from database) - `baseline_snapshot`, `staff_overrides`, `workflow_state`
2. **Layer 2: Algorithm State** (generated from snapshot + overrides) - allocations, calculations
3. **Layer 3: Override State** (user modifications) - `staffOverrides` (single source of truth)

### Key State Variables
- **`staffOverrides`**: Single source of truth for all staff modifications
  - `invalidSlots`: Array of `{ slot: number; timeRange: { start: string; end: string } }` (display-only)
  - `amPmSelection`: `'AM' | 'PM'` for therapist FTE = 0.5 or 0.25
  - `slotOverrides`: Manual slot transfers `{ slot1?, slot2?, slot3?, slot4? }`
  - `substitutionFor`: Non-floating PCA substitution override
  - `specialProgramOverrides`: Step 2.0 special program assignments
  - `__bedCounts`: Schedule-level bed count overrides per team
- **`pcaAllocations`**: `Record<Team, (PCAAllocation & { staff: Staff })[]>` - current PCA assignments
- **`calculations`**: `Record<Team, ScheduleCalculations | null>` - metrics per team
- **`baselineSnapshot`**: Frozen snapshot of dashboard state (per-date isolation)

## Allocation Workflow (5 Steps)

1. **Step 1**: Leave & FTE management → updates `staffOverrides`, calculates `average_pca_per_team` (target, persists through Steps 2-4)
2. **Step 2**: Therapist & Non-Floating PCA
   - **2.0**: Special Program Overrides Dialog
   - **Algorithm**: Therapist → Non-floating PCA → Special program PCA (except DRM) → Non-floating substitution
   - **2.1**: Non-Floating PCA Substitution Dialog
3. **Step 3**: Floating PCA wizard (3.0 → 3.1 → 3.2 → 3.3 → 3.4)
   - **3.1**: Adjust pending FTE & team order
   - **3.2**: Preferred slot reservation
   - **3.3**: Adjacent slot assignment (from special program PCAs only)
   - **3.4**: Final floating PCA algorithm
4. **Step 4**: Bed relieving calculation
5. **Step 5**: Review and finalization

## Key Algorithm Rules

- **DRM Special Program**: DRM is NOT a special program requiring designated PCA staff. It only adds +0.4 FTE to DRO team's `average_pca_per_team`. Skip DRM during special program PCA allocation phase.
- **Floating PCA Substitution**: Step 2 handles non-floating substitution; Step 3 should NOT assign to slots already covered by Step 2 substitutions.
- **Rounding Consistency**: Use `roundToNearestQuarterWithMidpoint()` for pending FTE checks to prevent infinite loops.

## PCA Total Values (Critical Distinction)

- **`totalPCAOnDuty`**: STABLE - Sum of FTE from all on-duty PCAs (used for requirement calculations)
- **`totalPCAFromAllocations`**: UNSTABLE - Sum of FTE from current allocations (reference/debugging only, NOT used in calculations)

**Key Rule**: Always use `totalPCAOnDuty` for requirement calculations. Never use `totalPCAFromAllocations` for calculations.

## Snapshot System

- **Per-Date Isolation**: Each schedule date has isolated `baseline_snapshot` to prevent cross-date contamination
- **Versioned Envelope**: Always wrap snapshots in envelope before saving (`buildBaselineSnapshotEnvelope`)
- **Validation**: Always validate on load (`validateAndRepairBaselineSnapshot`) to handle corrupted data gracefully
